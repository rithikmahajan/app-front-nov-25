import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  SafeAreaView,
  StatusBar,
  ScrollView,
  Alert,
  TextInput,
} from 'react-native';
import { Colors } from '../constants/colors';
import { useAddress } from '../contexts/AddressContext';
import { useCurrencyContext } from '../contexts/CurrencyContext';

const DeliveryOptionsStepTwoScreen = ({ navigation, route }) => {
  // Get selected delivery option from navigation params
  const { selectedDeliveryOption, postcode, deliveryType, isDomesticDelivery } = route.params || {};
  
  // State for address form
  const [addressForm, setAddressForm] = useState({
    fullName: '',
    phoneNumber: '',
    addressLine1: '',
    addressLine2: '',
    city: '',
    state: '',
    pincode: postcode || '',
    landmark: '',
  });

  // Use AddressContext to save addresses
  const { addAddress } = useAddress();
  
  // Currency context for pricing
  const { formatPrice } = useCurrencyContext();

  const handleBackPress = () => {
    navigation.goBack();
  };

  const handleInputChange = (field, value) => {
    setAddressForm(prev => ({
      ...prev,
      [field]: value
    }));
  };

  const validateForm = () => {
    const required = ['fullName', 'phoneNumber', 'addressLine1', 'city', 'state', 'pincode'];
    for (let field of required) {
      if (!addressForm[field].trim()) {
        Alert.alert('Validation Error', `Please enter ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
        return false;
      }
    }
    
    // Validate phone number (10 digits)
    if (!/^\d{10}$/.test(addressForm.phoneNumber)) {
      Alert.alert('Validation Error', 'Please enter a valid 10-digit phone number');
      return false;
    }
    
    // Validate pincode (6 digits)
    if (!/^\d{6}$/.test(addressForm.pincode)) {
      Alert.alert('Validation Error', 'Please enter a valid 6-digit pincode');
      return false;
    }
    
    return true;
  };

  const handleSaveAndContinue = async () => {
    if (!validateForm()) return;

    try {
      // Save address
      await addAddress({...addressForm, isDefault: true});
      
      // Continue to payment
      Alert.alert(
        'Address Saved',
        'Your address has been saved successfully. Proceeding to payment...',
        [
          {
            text: 'OK',
            onPress: () => {
              // Navigate to payment or bag screen
              navigation.navigate('Bag', {
                selectedDeliveryOption,
                deliveryAddress: addressForm,
                fromDeliveryFlow: true
              });
            }
          }
        ]
      );
    } catch (error) {
      console.error('Error saving address:', error);
      Alert.alert('Error', 'Failed to save address. Please try again.');
    }
  };

  return (
    <SafeAreaView style={styles.container}>
      <StatusBar barStyle="dark-content" backgroundColor={Colors.white} />

      {/* Header */}
      <View style={styles.header}>
        <TouchableOpacity onPress={handleBackPress} style={styles.backButton}>
          <Text style={styles.backArrow}>â€¹</Text>
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Delivery Address</Text>
        <View style={styles.headerRight} />
      </View>

      <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
        {/* Selected Delivery Option Summary */}
        <View style={styles.deliveryOptionSummary}>
          <Text style={styles.sectionTitle}>Selected Delivery Option</Text>
          <View style={styles.selectedOptionCard}>
            <View style={styles.optionHeader}>
              <Text style={styles.optionName}>{selectedDeliveryOption?.name}</Text>
              <Text style={styles.optionPrice}>
                {selectedDeliveryOption?.free ? 'FREE' : formatPrice(selectedDeliveryOption?.cost || 0)}
              </Text>
            </View>
            <Text style={styles.optionDescription}>{selectedDeliveryOption?.description}</Text>
            {selectedDeliveryOption?.estimatedDays && (
              <Text style={styles.optionEstimate}>
                Estimated delivery: {selectedDeliveryOption.estimatedDays} days
              </Text>
            )}
          </View>
        </View>

        {/* Address Form */}
        <View style={styles.addressSection}>
          <Text style={styles.sectionTitle}>Delivery Address</Text>
          
          <View style={styles.formGroup}>
            <Text style={styles.label}>Full Name*</Text>
            <TextInput
              style={styles.input}
              value={addressForm.fullName}
              onChangeText={(value) => handleInputChange('fullName', value)}
              placeholder="Enter your full name"
              placeholderTextColor={Colors.gray500}
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Phone Number*</Text>
            <TextInput
              style={styles.input}
              value={addressForm.phoneNumber}
              onChangeText={(value) => handleInputChange('phoneNumber', value)}
              placeholder="Enter 10-digit phone number"
              placeholderTextColor={Colors.gray500}
              keyboardType="phone-pad"
              maxLength={10}
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Address Line 1*</Text>
            <TextInput
              style={styles.input}
              value={addressForm.addressLine1}
              onChangeText={(value) => handleInputChange('addressLine1', value)}
              placeholder="House/Flat number, Building name"
              placeholderTextColor={Colors.gray500}
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Address Line 2</Text>
            <TextInput
              style={styles.input}
              value={addressForm.addressLine2}
              onChangeText={(value) => handleInputChange('addressLine2', value)}
              placeholder="Street, Area, Locality (Optional)"
              placeholderTextColor={Colors.gray500}
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>City*</Text>
            <TextInput
              style={styles.input}
              value={addressForm.city}
              onChangeText={(value) => handleInputChange('city', value)}
              placeholder="Enter city"
              placeholderTextColor={Colors.gray500}
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>State*</Text>
            <TextInput
              style={styles.input}
              value={addressForm.state}
              onChangeText={(value) => handleInputChange('state', value)}
              placeholder="Enter state"
              placeholderTextColor={Colors.gray500}
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Pincode*</Text>
            <TextInput
              style={styles.input}
              value={addressForm.pincode}
              onChangeText={(value) => handleInputChange('pincode', value)}
              placeholder="Enter 6-digit pincode"
              placeholderTextColor={Colors.gray500}
              keyboardType="numeric"
              maxLength={6}
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Landmark</Text>
            <TextInput
              style={styles.input}
              value={addressForm.landmark}
              onChangeText={(value) => handleInputChange('landmark', value)}
              placeholder="Nearby landmark (Optional)"
              placeholderTextColor={Colors.gray500}
            />
          </View>
        </View>

        {/* Save and Continue Button */}
        <TouchableOpacity style={styles.continueButton} onPress={handleSaveAndContinue}>
          <Text style={styles.continueButtonText}>Save Address & Continue</Text>
        </TouchableOpacity>
      </ScrollView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.white,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: Colors.gray200,
  },
  backButton: {
    padding: 8,
  },
  backArrow: {
    fontSize: 24,
    color: Colors.black,
    fontWeight: '300',
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: Colors.black,
  },
  headerRight: {
    width: 40,
  },
  content: {
    flex: 1,
    paddingHorizontal: 20,
  },
  deliveryOptionSummary: {
    marginTop: 20,
    marginBottom: 30,
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: '600',
    color: Colors.black,
    marginBottom: 16,
  },
  selectedOptionCard: {
    backgroundColor: Colors.gray50,
    borderRadius: 12,
    padding: 16,
    borderWidth: 2,
    borderColor: Colors.green500,
  },
  optionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  optionName: {
    fontSize: 16,
    fontWeight: '600',
    color: Colors.black,
    flex: 1,
  },
  optionPrice: {
    fontSize: 16,
    fontWeight: '600',
    color: Colors.green600,
  },
  optionDescription: {
    fontSize: 14,
    color: Colors.gray600,
    marginBottom: 4,
  },
  optionEstimate: {
    fontSize: 12,
    color: Colors.gray500,
    fontStyle: 'italic',
  },
  addressSection: {
    marginBottom: 30,
  },
  formGroup: {
    marginBottom: 20,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    color: Colors.black,
    marginBottom: 8,
  },
  input: {
    borderWidth: 1,
    borderColor: Colors.gray300,
    borderRadius: 8,
    paddingHorizontal: 16,
    paddingVertical: 12,
    fontSize: 16,
    color: Colors.black,
    backgroundColor: Colors.white,
  },
  continueButton: {
    backgroundColor: Colors.black,
    borderRadius: 8,
    paddingVertical: 16,
    alignItems: 'center',
    marginBottom: 30,
  },
  continueButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: Colors.white,
  },
});

export default DeliveryOptionsStepTwoScreen;
    // Animate out first, then call onClose
    Animated.timing(slideAnim, {
      toValue: screenHeight,
      duration: 250,
      useNativeDriver: true,
    }).start(() => {
      onClose();
    });
  };

  // Calculate dynamic pricing for payment
  const calculateDynamicPricing = () => {
    console.log('ðŸ’° Calculating dynamic pricing for delivery checkout');
    
    // Base subtotal from cart items
    const itemsSubtotal = getTotalPrice();
    
    // Dynamic delivery charges based on selected option and location
    let totalDeliveryCharge = 0;
    if (selectedDeliveryOption === 'free') {
      totalDeliveryCharge = 0;
    } else if (selectedDeliveryOption === 'international') {
      totalDeliveryCharge = 50; // International delivery cost
    }
    
    // Final total calculation
    const finalTotal = Math.max(0, itemsSubtotal + totalDeliveryCharge);
    
    return {
      itemsSubtotal,
      totalDeliveryCharge,
      finalTotal,
      razorpayAmount: isDomestic 
        ? Math.round(finalTotal * 100) // Convert to paise for Indian Razorpay
        : Math.round(finalTotal), // Keep as dollars for international
      totalAmountForAPI: finalTotal,
      currency: currentLocation.currency,
      isDomestic
    };
  };

  // Function to create Razorpay order
  const createRazorpayOrder = async () => {
    try {
      console.log('ðŸ” Creating Razorpay order from delivery options with bag items:', bagItems);
      
      // Validate cart using utility functions
      const cartValidation = validateCart(bagItems);
      
      if (!cartValidation.isValid) {
        console.error('âŒ Cart validation failed:', cartValidation.invalidItems);
        Alert.alert(
          'Cart Issues Found',
          `${cartValidation.invalidItems.length} items in your cart have issues. Please check your cart and try again.`,
          [{ text: 'OK' }]
        );
        return false;
      }
      
      const pricing = calculateDynamicPricing();
      const totalAmount = pricing.totalAmountForAPI;
      const razorpayAmount = pricing.razorpayAmount;
      
      // Format cart items for API
      const formattedCart = bagItems.map(item => formatCartItemForAPI(item));
      
      // Format address for API
      const formattedAddress = {
        firstName: selectedAddress.firstName || selectedAddress.name?.split(' ')[0] || 'Customer',
        lastName: selectedAddress.lastName || selectedAddress.name?.split(' ').slice(1).join(' ') || '',
        address: selectedAddress.address || selectedAddress.addressLine1,
        city: selectedAddress.city,
        state: selectedAddress.state,
        country: selectedAddress.country || 'India',
        pinCode: selectedAddress.pinCode || selectedAddress.zipCode,
        phoneNumber: selectedAddress.phoneNumber || selectedAddress.phone
      };

      // Prepare order data for API call
      const orderData = {
        amount: totalAmount, // Amount in rupees (not paise) - backend handles conversion
        cart: formattedCart,
        staticAddress: formattedAddress
      };

      console.log('ðŸ“¤ Sending Razorpay order data from delivery:', orderData);

      // API call to create order
      let response;
      try {
        response = await apiService.post('/razorpay/create-order', orderData);
      } catch (apiServiceError) {
        console.warn('apiService failed, trying yoraaAPI as fallback:', apiServiceError.message);
        response = await yoraaAPI.makeRequest('/api/razorpay/create-order', 'POST', orderData, true);
      }

      if (response && response.id) {
        console.log('âœ… Razorpay order created successfully:', response);
        
        // Initialize Razorpay payment
        await initializeRazorpayPayment(response, formattedAddress);
        return response;
      } else {
        const errorMsg = response?.message || response?.error || 'Failed to create Razorpay order';
        throw new Error(errorMsg);
      }
    } catch (error) {
      console.error('âŒ Error creating Razorpay order from delivery:', error);
      
      let errorMessage = 'Failed to create order. Please try again.';
      if (error.message && error.message.includes('Invalid SKU')) {
        errorMessage = 'There was an issue with one of your cart items. Please remove and re-add the items to your cart.';
      } else if (error.message && error.message.includes('status code 400')) {
        errorMessage = 'Invalid order data. Please check your cart items and delivery address.';
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      Alert.alert('Order Error', errorMessage);
      return null;
    }
  };

  // Function to initialize Razorpay payment
  const initializeRazorpayPayment = async (razorpayOrder, address) => {
    try {
      console.log('ðŸ’³ Initializing Razorpay payment from delivery with order:', razorpayOrder);

      const options = {
        description: 'Order Payment',
        image: 'https://your-app-logo.com/logo.png', // Replace with actual logo URL
        currency: razorpayOrder.currency,
        key: 'rzp_live_VRU7ggfYLI7DWV', // Live key from backend
        amount: razorpayOrder.amount,
        order_id: razorpayOrder.id,
        name: 'Yoraa',
        prefill: {
          email: 'customer@yoraa.com', // Replace with actual user email if available
          contact: address.phoneNumber,
          name: `${address.firstName} ${address.lastName}`
        },
        theme: { color: '#000000' }
      };

      console.log('ðŸš€ Opening Razorpay from delivery with options:', options);

      try {
        const paymentResponse = await RazorpayCheckout.open(options);
        console.log('âœ… Payment successful from delivery:', paymentResponse);
        
        // Verify payment with backend
        await verifyPayment(paymentResponse);
        
      } catch (paymentError) {
        console.log('âŒ Payment error/cancelled from delivery:', paymentError);
        
        if (paymentError.code === 'PAYMENT_CANCELLED') {
          Alert.alert(
            'Payment Cancelled', 
            'Your payment was cancelled. Would you like to try again?',
            [
              { 
                text: 'Cancel', 
                style: 'cancel'
              },
              { 
                text: 'Retry Payment', 
                onPress: () => initializeRazorpayPayment(razorpayOrder, address) 
              }
            ]
          );
        } else {
          Alert.alert(
            'Payment Failed', 
            'There was an issue processing your payment. You can retry or continue shopping.',
            [
              { 
                text: 'Cancel', 
                style: 'cancel'
              },
              { 
                text: 'Retry Payment', 
                onPress: () => initializeRazorpayPayment(razorpayOrder, address) 
              }
            ]
          );
        }
      }

      return true;
    } catch (error) {
      console.error('âŒ Error initializing Razorpay payment from delivery:', error);
      Alert.alert('Payment Error', 'Order created but payment initialization failed. Please contact support.');
      return null;
    }
  };

  // Function to verify payment
  const verifyPayment = async (paymentResponse) => {
    try {
      console.log('ðŸ” Verifying payment from delivery:', paymentResponse);
      
      const verificationData = {
        razorpay_order_id: paymentResponse.razorpay_order_id,
        razorpay_payment_id: paymentResponse.razorpay_payment_id,
        razorpay_signature: paymentResponse.razorpay_signature
      };

      console.log('ðŸ“¤ Sending verification data from delivery:', verificationData);

      // Parallel API calls for verification
      const apiCalls = [
        apiService.post('/razorpay/verify-payment', verificationData).catch(err => ({ error: err, source: 'apiService' })),
        yoraaAPI.makeRequest('/razorpay/verify-payment', 'POST', verificationData, true).catch(err => ({ error: err, source: 'yoraaAPI' }))
      ];

      console.log('âš¡ Making parallel API calls for verification from delivery...');
      const results = await Promise.allSettled(apiCalls);

      // Find first successful response
      let response = null;
      for (const result of results) {
        if (result.status === 'fulfilled' && result.value?.success) {
          response = result.value;
          console.log('âœ… Payment verification successful from delivery');
          break;
        }
      }

      if (response && response.success) {
        // Payment successful - clear bag and navigate to order confirmation
        console.log('ðŸŽ‰ Payment verification successful - navigating to order confirmation');
        
        // Clear the cart after successful payment
        clearBag();
        
        // Close the delivery modal
        handleClose();
        
        // Navigate to order confirmation with order details
        if (navigation) {
          navigation.navigate('orderconfirmationphone', {
            orderDetails: {
              orderId: response.orderId || paymentResponse.razorpay_order_id,
              paymentId: paymentResponse.razorpay_payment_id,
              amount: response.amount || calculateDynamicPricing().finalTotal,
              currency: response.currency || currentLocation.currency,
              deliveryAddress: selectedAddress,
              deliveryOption: selectedDeliveryOption,
              items: bagItems,
              timestamp: new Date().toISOString()
            }
          });
        }
      } else {
        console.error('âŒ Payment verification failed from delivery');
        Alert.alert('Payment Verification Failed', 'There was an issue verifying your payment. Please contact support.');
      }

    } catch (error) {
      console.error('âŒ Error verifying payment from delivery:', error);
      Alert.alert('Verification Error', 'Payment verification failed. Please contact support.');
    }
  };

  const handleContinue = async () => {
    // Debug logging to understand the selectedAddress structure
    console.log('ðŸ” handleContinue - selectedAddress:', selectedAddress);
    console.log('ðŸ” handleContinue - selectedAddress.id:', selectedAddress?.id);
    console.log('ðŸ” handleContinue - selectedAddress._id:', selectedAddress?._id);
    
    // Check if user has selected an address (check both id and _id as MongoDB uses _id)
    const addressId = selectedAddress?.id || selectedAddress?._id;
    if (!selectedAddress || !addressId) {
      console.log('âŒ No address selected, showing alert');
      Alert.alert('Address Required', 'Please select a delivery address to continue');
      return;
    }
    
    console.log('âœ… Address selected, proceeding with continue');

    // Check if we have items in the bag
    if (!bagItems || bagItems.length === 0) {
      Alert.alert('Empty Cart', 'Your cart is empty. Please add items before proceeding.');
      return;
    }

    // Set payment loading state
    setPaymentLoading(true);

    try {
      // If onStartPayment is provided, use the bag screen's payment flow
      if (onStartPayment && typeof onStartPayment === 'function') {
        console.log('Starting payment flow from delivery modal (bag flow)');
        // Close current modal first
        Animated.timing(slideAnim, {
          toValue: screenHeight,
          duration: 250,
          useNativeDriver: true,
        }).start(() => {
          onClose();
          onStartPayment();
        });
      } else {
        // Direct checkout flow from delivery options
        console.log('ðŸš€ Starting direct payment flow from delivery options');
        
        // Create Razorpay order and process payment
        const orderCreated = await createRazorpayOrder();
        
        if (!orderCreated) {
          console.log('âŒ Failed to create order, stopping payment flow');
          return;
        }

        // Payment flow will continue in initializeRazorpayPayment
        console.log('âœ… Payment flow initiated successfully');
      }
    } catch (error) {
      console.error('âŒ Error in handleContinue:', error);
      Alert.alert('Error', 'Failed to process your order. Please try again.');
    } finally {
      setPaymentLoading(false);
    }
  };

  const handleAddAddress = () => {
    // Handle add address action
    setShowAddAddressModal(true);
  };

  const handleAddressModalClose = () => {
    setShowAddAddressModal(false);
    setEditingAddress(null); // Clear editing address
    // Reload addresses after adding/editing
    loadAddresses();
  };

    const handleEditAddress = (address) => {
    // Handle address editing
    console.log('ðŸ  Edit address pressed:', address);
    console.log('ðŸ“‹ Address fields:', {
      firstName: address.firstName,
      lastName: address.lastName,
      phone: address.phone,
      address: address.address,
      city: address.city,
      state: address.state,
      pin: address.pinCode || address.pin,
      type: address.type
    });
    
    // Set the address to be edited first
    setEditingAddress(address);
    
    // Small delay to ensure state is updated before showing modal
    setTimeout(() => {
      setShowAddAddressModal(true);
    }, 50);
  };



  return (
    <View style={styles.fullScreenOverlay}>
      <TouchableOpacity 
        style={styles.backdrop} 
        activeOpacity={1} 
        onPress={handleClose}
      />
      <Animated.View
        style={[
          styles.modalContainer,
          {
            transform: [{ translateY: slideAnim }],
          },
        ]}
        {...panResponder.panHandlers}
      >
        {/* Drag Handle */}
        <View style={styles.dragHandleContainer}>
          <View style={styles.dragHandle} />
        </View>
        
        <SafeAreaView style={styles.modalContent}>
          <StatusBar barStyle="dark-content" backgroundColor={Colors.white} />

          {/* Header */}
          <View style={styles.header}>
            <Text style={styles.headerTitle}>Delivery</Text>
            <TouchableOpacity onPress={handleClose} style={styles.closeButton}>
              <Text style={styles.closeIcon}>âˆ’</Text>
            </TouchableOpacity>
          </View>

          <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
            {/* Delivery Options */}
            <View style={styles.section}>
              {/* Free Delivery */}
              <View style={styles.optionRow}>
                <View style={styles.checkboxContainer}>
                  <View style={[styles.checkbox, selectedDeliveryOption === 'free' && styles.checkboxChecked]}>
                    {selectedDeliveryOption === 'free' && <Text style={styles.checkMark}>âœ“</Text>}
                  </View>
                </View>
                <View style={styles.optionTextContainer}>
                  <Text style={styles.optionTitle}>Free Delivery</Text>
                  <Text style={styles.optionSubtitle}>Arrives Wed, 11 May to Fri, 13 May</Text>
                </View>
              </View>

              {/* International Delivery */}
              <View style={styles.optionRow}>
                <View style={styles.checkboxContainer}>
                  <View style={[styles.checkbox, selectedDeliveryOption === 'international' && styles.checkboxChecked]}>
                    {selectedDeliveryOption === 'international' && <Text style={styles.checkMark}>âœ“</Text>}
                  </View>
                </View>
                <View style={styles.optionTextContainer}>
                  <Text style={styles.optionTitle}>International Delivery</Text>
                  <Text style={styles.optionSubtitle}>Arrives Wed, 18 May to Fri, 13 May</Text>
                  <Text style={styles.optionPrice}>$50 + Delivery Charges</Text>
                </View>
              </View>
            </View>

            {/* Delivery Details */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Delivery Details</Text>

              {/* Render Saved Addresses */}
              {addresses.length > 0 ? (
                addresses.map((address, index) => (
                  <TouchableOpacity
                    key={address._id || index}
                    style={styles.addressRow}
                    onPress={() => {
                      console.log('ðŸ  Selecting address:', address._id, address.firstName, address.lastName);
                      selectAddress(address);
                    }}
                  >
                    <View style={styles.checkboxContainer}>
                      <View style={[styles.checkbox, selectedAddress?._id === address._id && styles.checkboxChecked]}>
                        {selectedAddress?._id === address._id && <Text style={styles.checkMark}>âœ“</Text>}
                      </View>
                    </View>
                    <View style={styles.addressTextContainer}>
                      <Text style={styles.addressName}>
                        {address.firstName && address.lastName 
                          ? `${address.firstName} ${address.lastName}` 
                          : address.name || 'No Name'}, {address.phone}
                      </Text>
                      <Text style={styles.addressDetails}>
                        {address.address}, {address.city}, {address.state} {address.pinCode || address.pin}
                      </Text>
                      <Text style={styles.addressType}>
                        {address.type ? `${address.type.charAt(0).toUpperCase()}${address.type.slice(1)} Address` : 'Home Address'}
                      </Text>
                    </View>
                    <TouchableOpacity onPress={() => handleEditAddress(address)}>
                      <Text style={styles.editText}>Edit</Text>
                    </TouchableOpacity>
                  </TouchableOpacity>
                ))
              ) : (
                <View style={styles.noAddressContainer}>
                  <Text style={styles.noAddressText}>No saved addresses found</Text>
                  <Text style={styles.noAddressSubtext}>Add an address to continue</Text>
                </View>
              )}
            </View>

            {/* Buttons */}
            <View style={styles.buttonContainer}>
              <TouchableOpacity 
                style={[styles.continueButton, paymentLoading && styles.continueButtonDisabled]} 
                onPress={handleContinue}
                disabled={paymentLoading}
              >
                <Text style={styles.continueButtonText}>
                  {paymentLoading ? 'Processing Payment...' : 'Continue'}
                </Text>
              </TouchableOpacity>

              <TouchableOpacity style={styles.addAddressButton} onPress={handleAddAddress}>
                <Text style={styles.addAddressButtonText}>Add Address</Text>
              </TouchableOpacity>
            </View>
          </ScrollView>
        </SafeAreaView>
      </Animated.View>
      
      {/* Add Address Modal */}
      <AddAddressModal
        visible={showAddAddressModal}
        onClose={handleAddressModalClose}
        editingAddress={editingAddress}
      />
    </View>
  );
};

const styles = StyleSheet.create({
  fullScreenOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    zIndex: 10000,
  },
  backdrop: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
  },
  modalContainer: {
    position: 'absolute',
    bottom: 0,
    left: 0,
    right: 0,
    backgroundColor: Colors.white,
    borderTopLeftRadius: 16,
    borderTopRightRadius: 16,
    maxHeight: screenHeight * 0.9,
    minHeight: screenHeight * 0.5,
  },
  dragHandleContainer: {
    paddingVertical: 12,
    alignItems: 'center',
    borderTopLeftRadius: 16,
    borderTopRightRadius: 16,
  },
  dragHandle: {
    width: 40,
    height: 4,
    backgroundColor: '#C7C7CC',
    borderRadius: 2,
  },
  modalContent: {
    flex: 1,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 20,
    paddingVertical: 24,
    borderBottomWidth: 1,
    borderBottomColor: Colors.gray200,
  },
  headerTitle: {
    fontSize: 16,
    fontWeight: '500',
    color: Colors.black,
    flex: 1,
  },
  closeButton: {
    width: 28,
    height: 28,
    justifyContent: 'center',
    alignItems: 'center',
  },
  closeIcon: {
    fontSize: 18,
    color: Colors.black,
    fontWeight: 'bold',
  },
  content: {
    flex: 1,
  },
  section: {
    borderBottomWidth: 1,
    borderBottomColor: Colors.gray200,
  },
  optionRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingVertical: 24,
    borderTopWidth: 1,
    borderTopColor: Colors.gray200,
  },
  checkboxContainer: {
    marginRight: 22,
  },
  checkbox: {
    width: 20,
    height: 20,
    borderRadius: 10,
    borderWidth: 2,
    borderColor: Colors.black,
    justifyContent: 'center',
    alignItems: 'center',
  },
  checkboxChecked: {
    backgroundColor: Colors.black,
  },
  checkMark: {
    color: Colors.white,
    fontSize: 12,
    fontWeight: 'bold',
  },
  optionTextContainer: {
    flex: 1,
  },
  optionTitle: {
    fontSize: 16,
    fontWeight: '400',
    color: Colors.black,
    marginBottom: 8,
  },
  optionSubtitle: {
    fontSize: 16,
    color: Colors.gray600,
    marginBottom: 2,
  },
  optionPrice: {
    fontSize: 16,
    color: Colors.gray600,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '500',
    color: Colors.black,
    paddingHorizontal: 20,
    paddingVertical: 24,
    borderTopWidth: 1,
    borderTopColor: Colors.gray200,
  },
  addressRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingVertical: 24,
    borderTopWidth: 1,
    borderTopColor: Colors.gray200,
  },
  addressTextContainer: {
    flex: 1,
    marginRight: 16,
  },
  addressName: {
    fontSize: 16,
    fontWeight: '400',
    color: Colors.black,
    marginBottom: 8,
  },
  addressDetails: {
    fontSize: 16,
    color: Colors.gray600,
  },
  editText: {
    fontSize: 12,
    color: Colors.black,
    fontWeight: '400',
  },
  buttonContainer: {
    paddingHorizontal: 20,
    paddingVertical: 16,
    gap: 14,
  },
  continueButton: {
    backgroundColor: Colors.black,
    borderRadius: 100,
    paddingVertical: 16,
    alignItems: 'center',
  },
  continueButtonDisabled: {
    backgroundColor: Colors.gray300,
    opacity: 0.6,
  },
  continueButtonText: {
    fontSize: 16,
    fontWeight: '500',
    color: Colors.white,
  },
  addAddressButton: {
    backgroundColor: Colors.white,
    borderWidth: 1,
    borderColor: Colors.gray200,
    borderRadius: 100,
    paddingVertical: 16,
    alignItems: 'center',
  },
  addAddressButtonText: {
    fontSize: 16,
    fontWeight: '500',
    color: Colors.black,
  },
  addressType: {
    fontSize: 12,
    color: '#666666',
    marginTop: 2,
    fontStyle: 'italic',
  },
  noAddressContainer: {
    alignItems: 'center',
    paddingVertical: 20,
  },
  noAddressText: {
    fontSize: 16,
    color: Colors.black,
    fontWeight: '500',
    marginBottom: 4,
  },
  noAddressSubtext: {
    fontSize: 14,
    color: '#666666',
  },
});

export default DeliveryOptionsStepTwoScreen;
